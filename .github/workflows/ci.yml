name: Continuous Integration

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

permissions:
    contents: write
    pull-requests: read

jobs:
    test:
        runs-on: ubuntu-latest
        name: "Test and Build"
        steps:
            - name: "Checkout"
              uses: actions/checkout@v5

            - name: "Set up Go"
              uses: actions/setup-go@v5
              with:
                  go-version: "1.24"

            - name: "Run tests"
              run: make check

            - name: "Build binary"
              run: make build

    release-tag:
        runs-on: ubuntu-latest
        if: ${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}
        needs: ["test"]
        name: "Create Release Tag"
        outputs:
            RELEASE_TAG: ${{ steps.tag_version.outputs.new_tag }}
        steps:
            - name: "Checkout"
              uses: actions/checkout@v5

            - name: Release Tag
              id: tag_version
              uses: mathieudutour/github-tag-action@v6.2
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}

    create-release:
        name: "Create Release"
        runs-on: ubuntu-latest
        needs: ["release-tag"]
        steps:
            - name: "Checkout"
              uses: "actions/checkout@v5"
              with:
                  fetch-depth: 0

            - name: "Set up Go"
              uses: actions/setup-go@v5
              with:
                  go-version: "1.24"

            - name: "Run GoReleaser"
              uses: goreleaser/goreleaser-action@v6
              with:
                  distribution: goreleaser
                  version: latest
                  args: release --clean
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  HOMEBREW_TAP_GITHUB_TOKEN: ${{ secrets.HOMEBREW_TAP_GITHUB_TOKEN }}
